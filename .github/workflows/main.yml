name: Deploy server
on: push
jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_DEFAULT_REGION: eu-west-2
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    defaults:
      run:
        working-directory: iac
    outputs:
      ip: ${{ steps.obtain_ip.outputs.ip }}
    steps:
      - uses: actions/checkout@v2
      - name: terraform init
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=${{ env.TF_STATE_KEY }}"
        env:
          TF_STATE_BUCKET: appserver-tfstate
          TF_STATE_KEY: appserver.tfstate
      - name: terraform plan
        run: terraform plan -out=tfplan -input=false
      - name: terraform apply
        run: terraform apply -input=false tfplan
      - name: obtain ip
        id: obtain_ip
        run: |
          SERVER_IP=$(terraform output -raw server_ip)
          echo "::set-output name=ip::$SERVER_IP"
  configure:
    runs-on: ubuntu-latest
    needs: deploy
    defaults:
      run:
        working-directory: playbooks
    steps:
      - uses: actions/checkout@v2
      - run: echo ${{ needs.deploy.outputs.ip }} >> inventory.ansible
      - run: echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ssh.key
      - run: chmod 600 ssh.key
      - run: |
          ANSIBLE_HOST_KEY_CHECKING=false ansible-playbook \
            --inventory inventory.ansible \
            --user ubuntu \
            --private-key ssh.key \
            docker-install.yml
